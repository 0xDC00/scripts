// ==UserScript==
// @name         STEINS;GATE (Traditional Chinese)
// @version      1.00
// @author       ForzonLazure (based on DC's script)
// @description  [PC] https://store.steampowered.com/app/412830/STEINSGATE/
// * MAGES Engine
// ==/UserScript==
const engine = require('./libPCMAGES.js');

const table = createTable();
const mainHandler = trans.send(handler, '250+');

engine.setHookDialog(mainHandler);
engine.setHookMail(table, trans.send);

function handler(regs, index) {
    const address = regs[index];

    console.log('onEnter');
    //console.log(hexdump(address, { header: false, ansi: false, length: 0x50 }));
    let s = engine.readString(address, table);

    return s;
}

//-------------------------------------------------
function createTable() {
    const table = [];

    // PrivateUseCharacters
    // https://github.com/CommitteeOfZero/sc3tools/blob/main/resources/sghd/compound_chars.map
    const compound_chars = `
[E000-E01A]=?
[E01C]=¹⁸
[E01D]=⁻¹⁹
[E01E]=⁻²⁴
[E01F]=キタ
[E020]=ー
[E021-E067]=①
[E068]=,_
[E06D-E07F]=?
[E094]=ｷﾞ
[E095]=ョエ
[E096]=カエ
[E097]=レ
[E098]=八八
[E099]=アッ
[E09A]=ー
[E09B]=マダ
[E09C]=ー
[E09D]=チン
[E09E]=オワ
[E09F]=タ
`.split(/\r?\n/).filter(i => i);
    for (const c of compound_chars) {
        const pair = c.split('=');
        if (pair.length != 2) continue;

        const key = pair[0].replace(/^\s*\[|\]$/g, '').split('-');
        const val = pair[1];

        if (key.length === 1) key.push(key[0]);

        const start = parseInt(key[0], 16);
        const end = parseInt(key[1], 16);
        for (let i = start; i <= end; i++) {
            const charCode = ((i & 0xFF) << 8) | i >> 8; // swap endian
            table[charCode] = val;
        }
    }

    // based on: https://github.com/CommitteeOfZero/sc3tools/tree/main/resources/sghd
    // rows   : 61
    // column: 64 (1row = 64chars) ′
    const charset = (
        '　0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz ' + // 0 8000-803F
        '/:-;!?′.@#%~*&`()°^>+<ﾉ･=″$′,[＼]_{|}                           …' + // 1 8040-807F ('\ = ′＼)
        '０１２３４５６７８９ＡＢＣＤＥＦＧＨＩＪＫＬＭＮＯＰＱＲＳＴＵＶＷＸＹＺａｂｃｄｅｆｇｈｉｊｋｌｍｎｏｐｑｒｓｔｕｖｗｘｙｚ、。' + // 2 8080-80BF
        '，．：；？！゛゜‘’“”（）〔〕［］｛｝〈〉《》「」『』【】＜＞〖〗・…〜ー♪―ぁぃぅぇぉっゃゅょゎァィゥェォッャュョヮヵヶ①②' + // 3 80C0-80FF (⋯ -> …)
        '③④⑤⑥⑦⑧⑨⑩⑪⑫⑬ⁿ²％–—＿／•' + // 4 8100-813F
        'βγζημξρστυφχψωÅ√◯⌐¬∣¯Д∥αδεθικλνο' + // 5 8140-817F
        'πヽヾゝゞ〃仝々〆〇＼＋－±×÷＝≠＜＞≦≧∞∴♂♀℃￥＄￠￡％＃＆＊＠§☆★○●◎◇◆□■△▲▽▼※〒→←↑↓〓∈∋⊆⊇⊂⊃∪' + // 6 8180-81BF
        '∩∧∨￢⇒⇔∀∃∠⊥⌒∂∇≡≒≪≫∽∝∵∫∬‰♯♭♪†‡¶あいうえおかがきぎくぐけげこごさざしじすずせぜそぞただちぢつづてでとど' + // 7 81C0-81FF
        'なにぬねのはばぱひびぴふぶぷへべぺほぼぽまみむめもやゆよらりるれろわゐゑをんアイウエオカガキギクグケゲコゴサザシジスズセゼソゾタ' + // 8 8200-823F
        'ダチヂツヅテデトドナニヌネノハバパヒビピフブプヘベペホボポマミムメモヤユヨラリルレロヮワヰヱヲンヴΑΒΓΔΕΖΗΘΙΚΛΜΝΞΟ' + // 9 8240-827F
        'ΠΡΣΤΥΦΧΨΩⅠⅡⅢⅣⅤⅥⅦⅧⅨⅩ∮∑∟⊿                                         ' + // 10 8280-82BF
        'ㄅㄆㄇㄈㄉㄊㄋㄌㄍㄎㄏㄐㄑㄒㄓㄔㄕㄖㄗㄘㄙㄚㄛㄜㄝㄞㄟㄠㄡㄢㄣㄤㄦㄧㄨㄩ                            ' + // 11 82C0-82FF
        '娃阿哀愛挨逢握姐或安按暗案以伊位依偉委威意慰易椅為畏異移維胃衣謂違遺域育郁磯一溢逸茨芋允印咽員因引飲淫蔭院陰吋右宇烏羽迂雨窺渦唄' + // 12 8300-833F
        '浦瓜閏云運雲餌叡嬰影映曳永泳洩英衛液疫益悅越厭園奄宴延怨掩援沿演炎煙燕苑遠於央奧往押旺橫王翁岡沖億屋憶桶乙俺卸恩音下化仮何佳加可' + // 13 8340-837F
        '夏家寡科暇果架歌河火禍稼花苛茄荷華蝦課嘩貨過俄我牙画芽蛾賀雅餓駕介会解回塊快怪悔恢戒拐改械海灰界皆絵開階貝凱外咳害慨概蓋街該蛙劃' + // 14 8380-83BF
        '嚇各廓格核獲確穫角赫較隔革岳額顎掛割喝恰括活滑葛褐轄且蒲茅粥瓦乾冠寒刊喚堪姦完官干幹患感慣憾換敢柑款汗漢環甘監看管簡緩缶翰観貫還' + // 15 83C0-83FF
        '鑑間閑関館丸含岸玩眼岩願企危喜器基奇嬉寄岐希幾忌揮机既期棋棄機帰毅汽祈季稀紀徽規記貴起軌輝飢騎鬼偽儀宜技擬欺疑義誼議菊鞠吉吃喫橘' + // 16 8400-843F
        '客虐逆久仇休及吸宮急救求泣球究窮笈級糾給牛去居巨拒虚許距鋸禦魚享京供僑兇競共凶協卿叫喬境強怯恐恭教橋況狂狭矯胸脅興蕎鏡響饗驚仰凝' + // 17 8440-847F
        '暁業局曲極玉桐僅勤均巾斤欣琴禁筋緊謹近金吟銀九句狗矩苦具愚空偶寓遇串櫛屈靴熊栗桑君訓群軍郡係傾兄型契形慶携敬景稽系継荊計警迎劇激' + // 18 8480-84BF
        '隙傑欠決潔穴結血月件倦健兼券喧堅嫌建懸拳捲牽犬研肩見謙賢遣鍵験元原幻弦減源玄現言限乎個古呼固姑孤己庫故狐糊股胡虎誇跨雇顧鼓五互伍' + // 19 84C0-84FF
        '午吾後御悟語誤護交候光公功勾厚口向后喉好孔工巧巷幸康弘恒慌抗拘控攻昂晃更校構江洪港溝甲皇硬稿紅絞考肯腔膏航荒行衡講貢購郊鋼降項香' + // 20 8500-853F
        '高剛劫合拷豪轟克刻告酷獄腰忽骨込此頃今困婚恨懇昏根混痕魂些叉左差沙詐鎖坐座挫催再最哉塞妻宰彩才採済災采祭細菜裁載際在材罪財坂崎埼' + // 21 8540-857F
        '作削咋昨柵窄策索錯匙冊刷察撮擦殺薩三傘参山撒散燦算酸餐斬暫仔伺使刺司史四士始姿子屍市師志思指支斯施旨枝止死氏私紙紫肢至視詞詩試誌' + // 22 8580-85BF
        '資賜飼事似侍字寺持時次滋治爾磁示而耳自式識軸七執失嫉室悉漆疾質実柴射捨赦斜煮社者謝車遮蛇邪借尺灼若寂弱惹主取守手朱殊狩珠種腫趣酒' + // 23 85C0-85FF
        '首受授樹需収周宗就州修愁拾洲秀秋終習臭襲輯週酬集醜什住充十柔汁縦重叔宿淑祝縮熟出術述俊春瞬准循旬殉淳準潤盾純巡遵順初所暑緒署書薯' + // 24 8600-863F
        '諸助女序除傷償勝召商唱嘗宵小少尚床廠承抄招掌捷昇昭晶松沼消湘焦照症省硝祥章笑紹肖菖蕉衝証詳象賞鍾鐘障鞘上城場常情擾狀蒸飾拭植織職' + // 25 8640-867F
        '色食蝕辱尻伸信侵唇審心慎振新森浸深真神紳臣薪親診身辛進針震人刃塵尋甚腎訊迅陣須逗吹垂帥推水睡衰遂瑞崇数趨杉頗雀澄摺寸世瀨是制勢姓' + // 26 8680-86BF
        '征性成政整星晴棲栖正清牲生盛精聖製西誠誓請醒青脆隻席惜戚斥析石積籍績脊責赤跡蹟切拙接折設節雪舌仙先千占宣尖川戦扇撰泉洗染煽旋穿箭' + // 27 86C0-86FF
        '線羨腺船薦詮選閃鮮前善漸然全噌塑措曾楚狙疏礎祖租粗素組蘇訴阻鼠僧創倉喪奏爽層想掃操早曹槍槽燥相糟総綜草葬蒼裝走送遭像憎造促側則即' + // 28 8700-873F
        '息捉束測足速俗賊族続袖其存孫尊損村遜他多太唾妥惰打陀体堆耐帯待態戴替泰胎腿袋退逮隊代台大第題鷹啄宅托拓託濁諾只叩但達奪棚谷誰丹単' + // 29 8740-877F
        '嘆坦探旦淡短端綻蛋誕鍛壇断暖段男談知地弛恥智池痴稚置致馳築畜竹筑蓄逐秩窒茶着中宙忠抽昼柱注衷註著丁兆寵帳張懲挑暢朝潮町脹腸蝶調諜' + // 30 8780-87BF
        '超跳長頂鳥直沈珍鎮墜椎槌追痛通塚綴潰爪吊釣低停偵剃貞呈堤定帝底庭弟抵挺提梯汀程締訂釘泥摘敵滴的笛適溺哲徹撤轍典填天展店添纏甜貼顛' + // 31 87C0-87FF
        '殿田電吐堵塗妬徒渡登賭途都努度土奴怒倒冬凍刀唐塔套島投搭東桃棟湯燈当等答筒糖統到菫藤討豆踏逃透陶頭騰闘動同堂導撞洞瞳童胴萄道匿得' + // 32 8800-883F
        '德特督禿毒読橡突敦沌豚頓奈那內乍謎灘捺鍋南軟難汝二尼肉虹日乳入如尿任忍認寧熱年念燃粘之濃納能農巴把播波派破婆罵馬排敗杯盃牌背肺輩' + // 33 8840-887F
        '配倍培媒梅買賠陪這伯博拍泊白箔薄迫漠爆縛莫駁函箱肌八鉢伐罰抜伴判半反叛搬斑板氾版犯班繁般販範煩頒飯挽番盤蕃卑否彼悲扉批披比泌疲皮' + // 34 8880-88BF
        '碑秘罷肥被誹費避非飛備尾微眉美鼻匹膝肘必畢筆逼媛紐百標漂票表評描病秒苗蒜品瀕貧賓頻敏瓶不付埠夫婦富布府怖扶敷普浮父符腐膚芙負賦附' + // 35 88C0-88FF
        '侮撫武舞葡部封楓風伏副復幅服福腹複覆淵弗沸物分吻噴憤扮奮粉紛文聞兵幣平弊柄並蔽閉米頁壁癖別瞥蔑偏変片篇編返遍便勉弁鞭保鋪捕補輔募' + // 36 8900-893F
        '墓慕母倣包呆報奉峰崩抱放方朋法泡砲縫胞芳萌蓬蜂訪邦鋒飽鳳乏亡傍剖坊妨帽忘忙房暴望某棒冒膨謀貌防北僕墨撲牧勃殆奔本翻凡盆摩磨魔麻埋' + // 37 8940-897F
        '妹昧枚哩幕膜枕亦又抹末沫繭万慢漫蔓味未魅密蜜稔脈妙民眠務夢無矛霧娘冥名命明盟迷鳴滅免棉面摸模茂妄孟毛猛盲網耗蒙儲木黙目餅尤戻問悶' + // 38 8980-89BF
        '紋門也夜爺耶野厄役約躍靖柳愉油癒諭輸唯優勇友幽悠憂有柚涌猶由裕誘遊郵雄融夕予余輿預傭幼妖容庸揚擁洋溶用羊耀葉要陽養慾抑欲沃浴翼羅' + // 39 89C0-89FF
        '螺裸来雷洛絡落欄濫藍蘭利履李理璃裏裡里離陸律率立掠略流溜留粒隆龍侶慮旅虜了亮両凌料梁涼療瞭良諒量領力倫厘林淋燐琳臨輪鱗瑠累類令伶' + // 40 8A00-8A3F
        '例冷鈴零麗歷列劣烈裂廉憐漣簾練聯蓮連魯路露廊弄朗浪漏牢狼老郎六麓錄論和話歪惑蕨碗腕丼乖乘亂豫舒亞仍仗估佛佇侈佩佯來侖儘俘俐倚倡俯' + // 41 8A40-8A7F
        '們倆假會做傲傳價僵儼兀兒兔兩冕冤冰冽處凰凵刪剌剪剩劍劈劑辨勁勞勵勸匣匯區卻卷參雙曼叮叭吁呀吭吼吝呵呱咒呻咀哇咬哄哈哥哦唔哽哭售唸' + // 42 8A80-8ABF
        '喀咯喊啾喘單喃喇鳴嗅嗜嗤嘔嘖嗽嘛營嘴嘲嘸噫嘯噬噪嚥嚮嚴囂圈國圍圓團圖址坡埃堡塢毀墅墟壞墮壓壘壯壽夸夾奕奢奧奸姆姨娜婉媚媽嬌孛孩孵' + // 43 8AC0-8AFF
        '學它寇實寢寞寥寫寰寶將專對屁屆屎屏屬岔峙崗巫已帶麼廁廂廈廣廚廢廳彈彌彎彗彙彷徊很徑從徘徨怎怕恤悍悚悄悖惡惠悴惘愕惺惱愧慘憔憑憫懊' + // 44 8B00-8B3F
        '應懷懈懶懼戀截戮戰戲戳扁扎扣扛扼抉找抒抓抖拔拿拆擔拜拌拇拉拯挾搜捏掀捶掏掉揆揣揉插搖搓搶攝攪撕撓撥撩撈撼據擅擇擱舉擠抬擴擲擺攜攤' + // 45 8B40-8B7F
        '攣收攸效敘敞敲數斂斃變斷旁晝晨暈暹曉曖曠曦朦朧霸杆杞枉檜梳桿梭條棘榮榻榜樂權槲樞樣樓橇橢檢檻櫃櫻鬱盜歇歉歐歡歸歹殘殼毫氈氓氛氣汪' + // 46 8B80-8BBF
        '沒沮沾泛衍涎濤涵涸淨淒淺渾渺滿游滓溯滔滕灌滾漿滲滯漲澀潛潘澳澡澤濟濕濱濺瀏濾瀘瀟瀰灑灣炙炒炸炮烙焉煥煌燻熬燒燿爍爐爛爭爬牆犒犧狄' + // 47 8BC0-8BFF
        '狠狡狹猜猴猥猾獎默獨獸獵獻珈玻瑟瑜瑰瑪甦畫當疊痂疼痍痊痙痺瘋瘡癢發皙皺盂盒盡盧盪眩眸睫睛睹瞎瞑瞞瞰瞼瞻矚矜矣矮礦碎碌碼磅礙祟祕禧' + // 48 8C00-8C3F
        '齋禪禮稍稱穗穢穩穹窗窩竅竄竊站竭笨筍箍籠簽籤粹糯絲經綽總綯緝緻縣縱繃縲繞繪繩繼續纖纜缸缺罐罕罩羔羞翅翔翹聊聚聳聲聰聽肆肅肓肚胃胖' + // 49 8C40-8C7F
        '腋脾腑腦膊膀膠膽臀臂臉臍臟與舊舍舖艙艱艷艾芒芻芬苟莓茵茲茫莎莊莉菁菲蒂萬蒟蒻蔔薛藉藏藝藥蘋蘿號虧蜃蜷晴蝴螢螂雖螳蟲蠢蠻衫裔裙裝裏' + // 50 8C80-8CBF
        '褻襯覺覽觀觸訝詛詭詢誨誦諫諧諷謐謗謠證譯譴譽讀讓讚豁豎豐豬貪貳賈賁賤賣賽賺贊贏贖趁跌跪跟踐蹂蹊蹈蹤蹲躇躊躬軋輕輛輾轉轎辜辭辯迪迴' + // 51 8CC0-8CFF
        '逅逞遞隨遲邂遽邁邀邊邏扈鄙鄰醋醉醫醯釁釋鈔鈕鉤銹銷錢鏘鏈鐵鑰鑽闊闔闖關陌陋陷險隧隱隸雜霍霄霎霹靈靂靜靠勒鞋竟頌頸顆顏顫顯顳飄飆餒' + // 52 8D00-8D3F
        '餘饒駟駛駝駭駱騁騙騷驅驕驗驟骰骼髓體髮鬆鬣鬥鬧鬨鴉鶯鹹鹽麥黎黏點黴齊齒齣齡龜遙厲增寬德悅擎橫澈瀨炫皂綠菇詹賴閒黑丟份仿伙佈佔你俱' + // 53 8D40-8D7F
        '值偷傢傻儆內划剎剝勻卡另吞吧吱吵呃呢呸咔咕咖咚咦咧咪咻哪哼唉唬唵唷啃啊啞啟啡啤啥啦啪啵喂喔喲喵喻嗎嗑嗒嗝嗡嗦嗨嗯嗶嘍嘎嘟嘰嘻嘿噁' + // 54 8D80-8DBF
        '噓噗噠噢噩嚕嚨囉囊圾垃垮塌墊夠奶她妒妳娓娛嫵孬孽尬尷屌屜巢帕幫弒彆徵忐忑忪您愣懂戶扭扯扳拋拖拼挖掐掙掰揍揭搐搔搞搧摀摔摟摻撇撐撬' + // 55 8DC0-8DFF
        '撿擊擋攆攏攔攙晚晾暌曆曬朵查桌槳檔檯步歲歷殭每氧氫氮汙沉涉涰淚渴溫溼漩漪潑烤焊焰煞燙爸爹牠狀玫玷產甩疙痠瘦瘩盯盼眨眶眾睏睜睬睽瞄' + // 56 8E00-8E3F
        '瞇瞌瞧瞪砍砰砸碟碰碳碴祂禱稅簌糕糙糬糰絕綁緣繫繳耍脖脫腳舔芮菈萊虛蜓蟑蟬褲覷訕說謊貓趕趟趴跑踢踩踮踹蹋躝躲躺辦逛遝遢邋鄉醬銫銬銳' + // 57 8E40-8E7F
        '鋁錄錶鍊鏍鐳鑣閡閱闆阱雞頰餵航髒鹼麵黃龐勿徬歧恆雌凋琉祐啓湛髦卦垠婊兜憧憬丑夯輻框梢闢蔚躓踣浩咆倪煉踵餡跋呷燉愰惚颱黯眈菸厥紊絢' + // 58 8E80-8EBF
        '勺侷涔軀咿擂臺剋憊                                                       ' + // 59 8EC0-8EFF
        'ДёЯ—˙ˇˋˊöæ' + // 60 8F00-8F0C
        '').replace(/\r|\n/g, '');

    let charCode;
    for (let i = 0; i < charset.length; i++) {
        // by index
        //table.push(charset[i]);

        // by code
        charCode = 0x8000 + i;
        charCode = ((charCode & 0xFF) << 8) | charCode >> 8; // swap endian (0x8001 -> 0x0180)
        table[charCode] = charset[i];
    }

    return table;
}
